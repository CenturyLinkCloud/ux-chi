/*
 Library declaration.
  Notes:
  identifier includes the version of the library (git tag / branch)
  remote includes the repository git url
  credentialsId needs to be of the type SSH key in Jenkins
  _ at the end of the declaration loads the whole library

  This section always runs in the master jenkins.
*/

library(
      identifier: 'jsl-jenkins-shared-library@master',
      retriever: modernSCM(
        [
          $class: 'GitSCMSource',
          remote: "git@github.com:jfranciscohernbal/jsl-jenkins-shared-library.git",
          credentialsId: 'SCMAUTO_SSH_DEVOPS_PIPELINE',
          extensions: [[$class: 'WipeWorkspace']]
        ]
      )
    ) _

pipeline {

    environment {

      
      //  Credentials:
      //  GITHUB_TOKEN_CREDENTIALS github token, jenkins user password credential. SCMAUTO_GITHUB contains the GitHub token from SCMAuto user, which need to have access to the repository.
      //  GITHUB_SSH_CREDENTIALS github ssh private key, jenkins private key credential. SCMAUTO_SSH_DEVOPS_PIPELINE contains the SSH key from SCMAuto user, which need to have access to the repository.
      //  DOCKER_CREDENTIALS Docker access info, jenkins secret file credential with environment variables to export.
      //  KUBE_CREDENTIALS Kubernetes access info, jenkins secret file credential with environment variables to export. For PRs.
      //  KUBE_CREDENTIALS_TEST Kubernetes access info, jenkins secret file credential with environment variables to export. For branches.
      //  AMAZON_CREDENTIALS AWS access info, jenkins secret file credential with environment variables to export
      //  SONARQUBE_CREDENTIALS Sonarqube access info, jenkins secret text
      //  GCP_CREDENTIALS GCP access info, jenkins secret file credential with environment variables to export
      //  JIRA_CREDENTIALS Jira access info, jenkins secret file credential with environment variables to export
      //  MORPHEUS_CREDENTIALS Morpheus access info, jenkins secret text
      //  MSTEAMS_CREDENTIALS MS Teams access info, jenkins secret text
      //  QUALITY_GATE_CREDENTIALS Credentials to gather all the contract validation gates expected to be crossed.
      //  PROJECT_MAL The MAL of the project
      
      GITHUB_TOKEN_CREDENTIALS = 'SCMAUTO_GITHUB'
      GITHUB_SSH_CREDENTIALS = 'SCMAUTO_SSH_DEVOPS_PIPELINE'
      DOCKER_CREDENTIALS = ''
      KUBE_CREDENTIALS = ''
      KUBE_CREDENTIALS_TEST = ''
      KUBE_CREDENTIALS_PROD = ''
      AMAZON_CREDENTIALS = ''
      SONARQUBE_CREDENTIALS = ''
      GCP_CREDENTIALS = ''
      JIRA_CREDENTIALS = ''
      MORPHEUS_CREDENTIALS = ''
      MSTEAMS_CREDENTIALS = ''
      QUALITY_GATE_CREDENTIALS = ''
      //Deployment control credentialsId
      AUTHORIZED_USERS = ''
      DEPLOY_AUTH_TOKEN = ''

      // Custom project variables
      // Add 
      PROJECT_NAME = 'current_project'
      DOCKER_REPO ='current_project/current_project_repo'
      PROJECT_MAL = "current_project mal"


      
      BRANCH_NAME = GIT_BRANCH.split('/')[-1].trim().toLowerCase()
      COMMIT_ID = GIT_COMMIT.substring(0,7).trim().toLowerCase()
      PULL_REQUEST="pr-${env.CHANGE_ID}"
      IMAGE_NAME = "${env.PROJECT_NAME}"
      IMAGE_TAG =  "${env.PULL_REQUEST}"
      KUBE_DOCKER_SECRET_NAME = "${env.PROJECT_NAME}-${env.PULL_REQUEST}"
      KUBE_DOCKER_SECRET_NAME_TEST = "${env.PROJECT_NAME}-${env.BRANCH_NAME}"
      KUBE_DOCKER_SECRET_NAME_PROD = "${env.PROJECT_NAME}-${env.BRANCH_NAME}"
    }
    

    // Add parameters if needed or if deployment control is in place.
    // parameters {
    //      //https://www.jenkins.io/doc/book/pipeline/syntax/#parameters
    //  text(name: 'GCR', defaultValue: '', description: 'Enter the GCR description. Only used in deployment to production stage.')
    //  text(name: 'VERSION', defaultValue: '', description: 'Version to deploy. Only used in deployment to production stage.')
    // }


    
    // https://www.jenkins.io/doc/book/pipeline/syntax/#agent
    //Add agent sections in stages/stage if needed.
    
    agent {
        label 'Docker-enabled'
    }

    options {
      
      // https://www.jenkins.io/doc/book/pipeline/syntax/#options
      
      timestamps ()
      timeout(time: 1, unit: 'HOURS')
      buildDiscarder(logRotator(numToKeepStr:'10', daysToKeepStr: '30'))
      preserveStashes(buildCount: 10)
      disableConcurrentBuilds()
    }

    
    // https://www.jenkins.io/doc/book/pipeline/syntax/#triggers
    
    triggers {
      issueCommentTrigger('.*test this please.*')
    }

    stages {
      stage('Summary') {
        steps {
          script {
            sh script: """
                echo "PROJECT_NAME: ${PROJECT_NAME}"
                echo "DOCKER_REPO: ${DOCKER_REPO}"
                echo "GIT_BRANCH: ${GIT_BRANCH}"
                echo "GIT_COMMIT: ${GIT_COMMIT}"
                echo "BRANCH_NAME: ${BRANCH_NAME}"
                echo "COMMIT_ID: ${COMMIT_ID}"
                echo "PULL_REQUEST: ${PULL_REQUEST}"
                echo "CHANGE_ID: ${env.CHANGE_ID}"
                echo "IMAGE_NAME: ${IMAGE_NAME}"
                echo "IMAGE_TAG: ${IMAGE_TAG}"                        
            """, label: "Details summary"
          }
        }
      }
      stage('Authorize - Prod only') {
        when {
          branch 'master'
        }
        steps {
          script {
            jslDeploymentControlKnob()
          }
        }
      }
      stage('Static Code Analysis') {
        parallel {
          stage('Linting') {
            when {
              beforeAgent true
              not { branch 'master' }
            }
            agent {
                dockerfile {
                    filename 'Dockerfile'
                    dir 'cicd/docker/cypress'
                    label 'Docker-enabled'
                    //registryUrl DOCKER_REGISTRY
                    //registryCredentialsId DOCKER_LOGIN_CREDENTIALS
                }
            }
            steps {
              script{
                jslYarnWrapper('install')
                jslNpmWrapper('run lint')
                jslNpmWrapper('run prettier:checker')
              }
            }
          }
          stage('DevSecOps') {
            when {
              beforeAgent true
              not { branch 'master' }
            }
            steps {
              script {
                jslGitHubSecurityAlert()
              }
            }
          }
        }
      }
      stage('PR Build') {
        parallel {
          stage ('Building Chi') {
            when {
                beforeAgent true
                not { branch 'master' }
            } 
            agent {
              dockerfile {
                filename 'Dockerfile'
                dir 'cicd/docker/cypress'
                label 'Docker-enabled'
                // registryUrl DOCKER_REGISTRY
                // registryCredentialsId DOCKER_CREDENTIALS
              }
            }
            steps {
              script {
                jslYarnWrapper('install')
                jslNpmWrapper('run build')
              }
            }
          }
          stage ('Building Custom elements') {
            when {
                beforeAgent true
                not { branch 'master' }
            } 
            agent {
              dockerfile {
                filename 'Dockerfile'
                dir 'cicd/docker/cypress'
                label 'Docker-enabled'
                // registryUrl DOCKER_REGISTRY
                // registryCredentialsId DOCKER_CREDENTIALS
              }
            }
            steps {
              script {
                dir('src/custom-elements') {
                  jslYarnWrapper('install')
                  jslNpmWrapper('run build')
                }
              }
            }
          }
          stage ('Building Chi-vue') {
            when {
                beforeAgent true
                not { branch 'master' }
            } 
            agent {
              dockerfile {
                filename 'Dockerfile'
                dir 'cicd/docker/cypress'
                label 'Docker-enabled'
                // registryUrl DOCKER_REGISTRY
                // registryCredentialsId DOCKER_CREDENTIALS
              }
            }
            steps {
              script {
                dir('src/chi-vue') {
                  jslYarnWrapper('install')
                  jslNpmWrapper('run build:component')
                }
              }
            }
          }
        }
      }
      stage('Build for Production') {
        parallel {
          stage ('Building Chi') {
            when {
                beforeAgent true
                branch 'master'
            } 
            agent {
              dockerfile {
                filename 'Dockerfile'
                dir 'cicd/docker/cypress'
                label 'Docker-enabled'
                // registryUrl DOCKER_REGISTRY
                // registryCredentialsId DOCKER_CREDENTIALS
              }
            }
            steps {
              script {
                jslYarnWrapper('install')
                jslNpmWrapper('run build')
              }
            }
          }
          stage ('Building Custom elements') {
            when {
                beforeAgent true
                branch 'master'
            } 
            agent {
              dockerfile {
                filename 'Dockerfile'
                dir 'cicd/docker/cypress'
                label 'Docker-enabled'
                // registryUrl DOCKER_REGISTRY
                // registryCredentialsId DOCKER_CREDENTIALS
              }
            }
            steps {
              script {
                dir('src/custom-elements') {
                  jslYarnWrapper('install')
                  jslNpmWrapper('run build')
                }
              }
            }
          }
          stage ('Building Chi-vue') {
            when {
                beforeAgent true
                branch 'master'
            } 
            agent {
              dockerfile {
                filename 'Dockerfile'
                dir 'cicd/docker/cypress'
                label 'Docker-enabled'
                // registryUrl DOCKER_REGISTRY
                // registryCredentialsId DOCKER_CREDENTIALS
              }
            }
            steps {
              script {
                dir('src/chi-vue') {
                  jslYarnWrapper('install')
                  jslNpmWrapper('run build:component')
                }
              }
            }
          }
        }
      }
      stage ('Tests') {
        parallel {
          stage ('Unit Testing') {
            // agent {

            // }
            when {
              beforeAgent true
              not { branch 'master' }
            }
            steps {
              // script {
                echo "This will run Unit tests"
              // }
            }
          }
          stage ('E2E Testing') {
            // agent {

            // }
            when {
              beforeAgent true
              not { branch 'master' }
            }
            steps {
              // script {
                echo "This will run E2E tests"
              // }
            }
          }
        }
      }
      stage ('Publish to S3') {
        parallel {
          stage ('Publish Dev/Beta build') {
            when {
              beforeAgent true
              not { branch 'master' }
            }
            steps {
              // script {
                echo "This will publish dev build to S3"
              // }
            }
          }
          stage ('Publish Prod Build') {
            when {
              beforeAgent true
              branch 'master'
            }
            steps {
              // script {
                echo "This will publish Prod build to S3 & CDN"
              // }
            }
          }
        }
      }
      stage ('Cleaning...') {
        steps {
          echo "Pipeline finished!"
        }
      }
    }
    post {
      /*
      https://www.jenkins.io/doc/book/pipeline/syntax/#post

      Always post somewhere the watermark:
  	- md5sum of Jenkinsfile
  	- Output of the Jenkinsfile checker output
      */
      always {
        cleanWs()  
      }
    }
}